(function($){function compress(f,success){console.log(f);var reader=new FileReader(),img=new Image();var file=null;var canvas=document.createElement('canvas');var context=canvas.getContext('2d');img.onload=function(){var originWidth=this.width;var originHeight=this.height;var maxWidth=400,maxHeight=400;var targetWidth=originWidth,targetHeight=originHeight;if(originWidth>maxWidth||originHeight>maxHeight){if(originWidth/originHeight>maxWidth/maxHeight){targetWidth=maxWidth;targetHeight=Math.round(maxWidth*(originHeight/originWidth))}else{targetHeight=maxHeight;targetWidth=Math.round(maxHeight*(originWidth/originHeight))}}canvas.width=targetWidth;canvas.height=targetHeight;context.clearRect(0,0,targetWidth,targetHeight);context.drawImage(img,0,0,targetWidth,targetHeight);canvas.toBlob(success,f.type||'image/png')};reader.onload=function(e){img.src=e.target.result};reader.readAsDataURL(f)}function upload(opt){this.append('<input style="display:none" type="file" accept="'+(opt.accept||'image/jpg,image/jpeg,image/png')+'" />');this.on("click",function(ev){if(ev.target.nodeName!="INPUT"||ev.target.tagName!="INPUT"){$(this).find("input[type='file']").click()}}).find("input[type='file']").on("change",function(){var f=this.files[0];if(f){function compressHandle(b){var xhr=new XMLHttpRequest();var data=new FormData();if(f.name){b=new File([b],f.name)}data.append('file',b);xhr.onreadystatechange=function(status){if(xhr.readyState==4){if(opt&&typeof opt.callback=='function'){opt.callback(xhr.responseText)}}};xhr.onerror=function(){if(opt&&typeof opt.err=='function'){opt.err(xhr.responseText)}console.error("上传失败")};xhr.open('POST',opt&&opt.dist||'http://client.51zan.com/rest/front/storage/upload');xhr.send(data)}console.log('excute compress');compress(f,compressHandle)}})}$.fn.extend({initUpload:upload})})(jQuery);